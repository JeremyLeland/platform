<title>Validate line vs line function</title>
<link rel="stylesheet" href="../style.css">

<script type="module">

import { Canvas } from '../src/common/Canvas.js';
import { Line } from '../src/common/Line.js';
import { ValuesPanel } from '../src/common/ValuesPanel.js';

const line = new Line( 4, 3, 4, 4 );

const vars = {
  x1: 4,
  y1: 5,
  x2: 5,
  y2: 2,
  vx: -0.2,
  vy:  0.1,
  ax: 0,
  ay: -0.001,
}

new ValuesPanel( vars ).valueChanged = _ => canvas.redraw();

const canvas = new Canvas();
canvas.zoom = 1 / 10;

canvas.draw = ( ctx ) => {
  ctx.lineWidth = 0.2 * canvas.zoom;

  // Wall
  ctx.strokeStyle = 'orange';
  line.draw( ctx );

  // Test segment
  ctx.beginPath();
  ctx.moveTo( vars.x1, vars.y1 );
  ctx.lineTo( vars.x2, vars.y2 );
  ctx.strokeStyle = 'white';
  ctx.stroke();


  // Find overlap
  const px = line.x2 - line.x1;
  const py = line.y2 - line.y1;
  const D = ( px * px ) + ( py * py );

  const len = Math.sqrt( D );
  const normX = py / len;
  const normY = -px / len;

  // const B = ( vars.x2 - line.x1 ) * normX + ( vars.y2 - line.y1 ) * normY;
  
  [ [ vars.x1, vars.y1 ], [ vars.x2, vars.y2 ] ].forEach( p => {
    
    
    const u = ( ( p[ 0 ] - line.x1 ) * px + ( p[ 1 ] - line.y1 ) * py ) / D;

    if ( 0 <= u && u <= 1 ) {
      const overlap = ( p[ 0 ] - line.x1 ) * normX + ( p[ 1 ] - line.y1 ) * normY;
      
      ctx.beginPath();
      ctx.moveTo( p[ 0 ], p[ 1 ] );
      ctx.lineTo( p[ 0 ] - normX * overlap, p[ 1 ] - normY * overlap );
      ctx.strokeStyle = overlap < 0 ? 'red' : 'green';
      ctx.stroke();
    }
  } );

  // Can't use the same trick here -- want to know intersection of normal and line

  [ [ line.x1, line.y1 ], [ line.x2, line.y2 ] ].forEach( p => {

    const x1 = p[ 0 ];
    const y1 = p[ 1 ];
    const x2 = x1 + normX;
    const y2 = y1 + normY;

    const x3 = vars.x1;
    const y3 = vars.y1;
    const x4 = vars.x2;
    const y4 = vars.y2;

    const D = ( y4 - y3 ) * ( x2 - x1 ) - ( x4 - x3 ) * ( y2 - y1 );

    if ( D != 0 ) {
      const uA = ( ( x4 - x3 ) * ( y1 - y3 ) - ( y4 - y3 ) * ( x1 - x3 ) ) / D;
      const uB = ( ( x2 - x1 ) * ( y1 - y3 ) - ( y2 - y1 ) * ( x1 - x3 ) ) / D;

      if ( 0 <= uB && uB <= 1 ) {
        ctx.beginPath();
        ctx.moveTo( p[ 0 ], p[ 1 ] );
        ctx.lineTo( p[ 0 ] + normX * uA, p[ 1 ] + normY * uA );
        ctx.strokeStyle = uA < 0 ? 'red' : 'green';
        ctx.stroke();
      }
    }
  } );

  
  
}

</script>